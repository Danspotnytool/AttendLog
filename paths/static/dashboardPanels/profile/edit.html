<body>
    <style>
        #profileContainer {
            width: 90%;
            margin: 2rem auto;
            display: flex;
            gap: 2.5rem;
        }

        #profilePictureContainer {
            height: 100%;
            width: 35%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 1rem;
        }
        #profilePictureContainer img {
            height: 70%;
            width: 70%;
            border-radius: 50%;
            aspect-ratio: 1;
        }
        #profilePictureContainer label {
            padding: 1.5rem 4rem;
            border: unset;
            border-radius: 1.5rem;
            background-color: #c7d0d8;
            font-size: 1.75rem;
            cursor: pointer;
        }
        #profilePictureContainer input {
            display: none;
        }

        #profileInfoContainer {
            width: 65%;
        }
        #profileDescriptionCard {
            height: 100%;
            margin: auto;
            border-radius: 2rem;
            font-size: 2rem;
        }
        #profileDescriptionCard form {
            padding: 2rem;
            text-align: left;
        }
        #profileDescriptionCard label {
            margin-top: 0.5rem;
            margin-bottom: 0.25rem;
            display: block;
        }
        #profileDescriptionCard input {
            width: 100%;
            padding: 1rem;
            border: unset;
            border-radius: 1rem;
            font-size: 2rem;
            background-color: #c7d0d8;
            display: block;
        }
        #profileDescriptionCard table {
            width: 100%;
        }

        #profileDescriptionCard div {
            width: 100%;
            text-align: right;
        }
        #profileDescriptionCard div button {
            margin-top: 1rem;
            padding: 0.75rem 2rem;
            border: solid 2px #000000;
            border-radius: 100rem;
            font-size: 1.75rem;
            cursor: pointer;
        }
    </style>
    <div id="profileContainer">
        <div id="profilePictureContainer">
            <img src="../../assets/svg/profile-picture-icon.svg" alt="profilePicture" id="profilePicturePreview">
            <label for="profilePicture">Upload Picture</label>
        </div>
        <div id="profileInfoContainer">
            <div id="profileDescriptionCard">
                <form id="profileForm">
                    <input type="file" style="display: none;" accept="image/*" name="profilePicture" id="profilePicture">

                    <label for="firstName">First Name:</label>
                    <input type="text" name="firstName" id="firstName" placeholder="John">

                    <label for="lastName">Last Name:</label>
                    <input type="text" name="lastName" id="lastName" placeholder="Doe">

                    <label for="middleName">Middle Name:</label>
                    <input type="text" name="middleName" id="middleName" placeholder="Deguzman">

                    <table>
                        <tr>
                            <td>
                                <label for="prefix">Prefix:</label>
                                <input type="text" name="prefix" id="prefix" placeholder="Mr.">
                            </td>
                            <td>
                                <label for="suffix">Suffix:</label>
                                <input type="text" name="suffix" id="suffix" placeholder="Jr.">
                            </td>
                        </tr>
                    </table>
                    
                    <label for="birthday">Birthday:</label>
                    <input type="date" name="birthday" id="birthday" placeholder="Birthday">

                    <table>
                        <tr>
                            <td>
                                <label for="course">Course:</label>
                                <input type="text" name="course" id="course" placeholder="BSIT">
                            </td>
                            <td>
                                <label for="referenceID">Reference ID:</label>
                                <input type="text" name="referenceID" id="referenceID" placeholder="16551079569">
                            </td>
                        </tr>
                    </table>

                    <div>
                        <button type="button" id="submitButton">Submit</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <script>
        (async () => {
            const dtToday = new Date();
            let month = dtToday.getMonth() + 1;
            let day = dtToday.getDate();
            const year = dtToday.getFullYear();
            if(month < 10) { month = '0' + month.toString() };
            if(day < 10) { day = '0' + day.toString() };
            const maxDate = `${year}-${month}-${day}`;
            document.getElementById('birthday').setAttribute('max', maxDate);



            var canvasBuffer = null;



            document.getElementById('profilePicture').oninput = (event) => {
                document.getElementById('profilePicturePreview').src = '/assets/svg/profile-picture-icon.svg';

                const fileReader = new FileReader();

                fileReader.onload = (event) => {
                    // Read out file contents into buffer
                    const buffer = event.target.result;
                    // Crop the image to a square
                    const image = document.createElement('img');
                    image.src = buffer;
                    image.onload = async () => {
                        // Cut the image to a square
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        canvas.width = canvas.height = Math.min(image.width, image.height); 
                        ctx.drawImage(image, 0, 0, canvas.width, canvas.height);
                        // Get the image data from the canvas
                        const data = ctx.getImageData(0, 0, canvas.width, canvas.height);
                        canvasBuffer = data;
                        // Preview the image
                        document.getElementById('profilePicturePreview').src = canvas.toDataURL('image/png');
                        
                        // Convert the image to the other input
                        document.getElementById('profilePicture').value = document.getElementById('profilePictureInput').value;
                    };
                };

                fileReader.readAsDataURL(event.target.files[0]);
            };



            submitButton.onclick = () => {
                // Get the form
                const profileForm = document.getElementById('profileForm');
                const formData = new FormData(profileForm);

                // Get the userID from the cookie
                const { userID } = JSON.parse(document.cookie);

                // Send the form data to the server
                fetch(`${window.location.origin}/api/users/profile/${userID}/edit`, {
                    method: 'POST',
                    body: formData
                }).then((response) => {
                    if (response.status != 200) {
                        notify({
                            type: 'error',
                            header: 'Error: Unable to fetch the dashboard panel',
                            body: 'Try reloading the page',
                            footer: `${new Date()}`,
                            timeout: 5000
                        });
                        return;
                    };
                    return response.json();
                }).then(data => {
                    if (data.code != '200') {
                        return notify({
                            type: 'error',
                            header: 'Error: Unable to save the profile',
                            body: data.message,
                            footer: `${new Date()}`,
                            timeout: 5000
                        });
                    };
                    notify({
                        type: 'log',
                        header: 'Success: Profile saved',
                        body: 'Your profile has been saved',
                        footer: `${new Date()}`,
                        timeout: 5000
                    });
                    // Change window location to the dashboard profile page
                    window.location.href = `${window.location.origin}/dashboard/profile`;
                });
            };
        })();
    </script>
</body>